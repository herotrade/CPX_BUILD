# CPX 构建与部署使用指南

本指南覆盖从准备依赖、启动核心服务到配置 Nginx 反向代理的全流程操作。请按照顺序执行，并结合自身环境调整相关参数。

## 1. 准备数据库与 Redis 配置（可选）

1. 打开项目根目录的 `runner-compose.yml`。
2. 根据需要修改 MySQL、Redis 的账号与密码：
   - **MySQL**：`MYSQL_ROOT_PASSWORD`、`MYSQL_PASSWORD`、`MYSQL_USER` 等环境变量。
   - **Redis**：`redis_cache/redis.conf`、`redis_market/redis.conf` 中的 `requirepass`。
3. 若使用默认账号密码，可跳过此步骤直接构建。

## 2. 启动核心服务（runner-compose）

1. 在根目录执行：
   ```bash
   docker compose -f runner-compose.yml up -d
   ```
2. 首次运行会拉取镜像、初始化数据库和 Redis。可通过以下命令查看日志：
   ```bash
   docker compose -f runner-compose.yml logs -f
   ```
3. 确认容器全部处于 `Up` 状态后再进行下一步。

## 3. 启动钱包操作服务（可选）

如需部署链上钱包操作容器，执行 `scripts/setup_cpx_wallet.sh` 脚本：

```bash
bash scripts/setup_cpx_wallet.sh
```

该脚本会克隆/更新钱包服务代码仓库并通过 Docker Compose 启动对应容器，需先确保本地环境可访问 GitHub 且已安装 Docker / Docker Compose。

## 3. 配置域名解析

Nginx 配置中使用了多个二级域名前缀，请在 DNS 服务商或本地 `hosts` 中添加指向服务器 IP 的记录：

- `api.*`
- `manager.*`
- `h5.*`
- `pc.*`
- `www.*`

部署前请根据实际需求增删域名。

## 4. 编辑 Nginx 配置（可选）

1. Nginx 配置位于 `nginx/conf.d/cpx_exchange.conf`。
2. 如需调整域名或后端容器：
   - 修改各 `server` 块中的 `server_name` 列表。
   - 若后端容器名称或端口有变，更新对应 `upstream` [可选]
3. 若要使用自定义静态资源，确认以下目录已放置前端构建产物：
   - `nginx/html/manager`
   - `nginx/html/h5`
   - `nginx/html/pc`
   - `nginx/html/official`

## 5. 启动 Nginx 反向代理

1. 进入 Nginx 目录：
   ```bash
   cd nginx
   ```
2. 启动并加入 `data_network` 网络：
   ```bash
   docker compose up -d
   ```
3. 查看代理日志（可选）：
   ```bash
   docker compose logs -f
   ```

> 若修改了配置文件，重新执行 `docker compose up -d` 即可令改动生效；容器会在配置改变时自动重建。

完成上述步骤后，即可通过配置好的域名访问 API、管理端、H5、PC 端及官网服务。

## 6. 升级镜像与容器

以后台管理端 `cpxexchange/admin:prod` 为例，当上游镜像有更新时可按以下流程升级：

```bash
# 拉取最新镜像
docker compose -f runner-compose.yml pull cpx_manager

# 以新镜像重建容器（不中断其他服务）
docker compose -f runner-compose.yml up -d cpx_manager

# 若需要强制重建，可增加 --force-recreate
# docker compose -f runner-compose.yml up -d --force-recreate cpx_manager

# 升级完成后清理已失效的旧镜像（可选）
docker image prune
```
