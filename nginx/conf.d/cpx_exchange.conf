# 所有子服务的统一入口
upstream cpx_exchange_app {
    server cpx_runserver:9501;
}

upstream cpx_exchange_ws {
    server cpx_runserver:9510;
}

upstream cpx_manager_app {
    server cpx_manager:80;
}

upstream cpx_h5 {
    server cpx_h5:80;
}

# upstream cpx_pc {
#     server cpx_pc:80;
# }

# upstream cpx_website {
#     server cpx_website:80;
# }

# Simple helper to set common proxy headers
map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}

# -----------------------------------------------------------------------------
# API 域名（前台业务接口 + WebSocket）
# -----------------------------------------------------------------------------
server {
    listen 80;
    server_name api.bbbtrade.net;

    location / {
        proxy_pass http://cpx_exchange_app;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
    }

    location /ws/ {
        proxy_pass http://cpx_exchange_ws;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# -----------------------------------------------------------------------------
# 管理端（通过容器 cpx_manager 提供界面与接口）
# -----------------------------------------------------------------------------
server {
    listen 80;
    server_name manager.bbbtrade.net;

    location ~* \.(?:js|css|png|jpg|jpeg|gif|svg|ico|woff2?|ttf|otf|eot)$ {
        proxy_pass http://cpx_manager_app;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        add_header Cache-Control "public, max-age=2592000";
        expires 30d;
    }

    location / {
        proxy_pass http://cpx_manager_app;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
    }
}

# -----------------------------------------------------------------------------
# H5 端（静态站点，支持缓存；接口同样回源）
# -----------------------------------------------------------------------------
server {
    listen 80;
    server_name h5.bbbtrade.net;

    location ~* \.(?:js|css|png|jpg|jpeg|gif|svg|ico|mp4|webm|woff2?|ttf|otf)$ {
        proxy_pass http://cpx_h5;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        add_header Cache-Control "public, max-age=604800";
        expires 7d;
    }

    location / {
        proxy_pass http://cpx_h5;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
    }
}

# -----------------------------------------------------------------------------
# PC 端静态站点
# -----------------------------------------------------------------------------
# server {
#     listen 80;
#     server_name pc.bbbtrade.net;

#     location ~* \.(?:js|css|png|jpg|jpeg|gif|svg|ico|woff2?|ttf|otf)$ {
#         proxy_pass http://cpx_pc;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#         proxy_http_version 1.1;
#         add_header Cache-Control "public, max-age=2592000";
#         expires 30d;
#     }

#     location / {
#         proxy_pass http://cpx_pc;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#         proxy_http_version 1.1;
#     }
# }

# -----------------------------------------------------------------------------
# 官方网站（纯静态，可单独部署）
# -----------------------------------------------------------------------------
# server {
#     listen 80;
#     server_name www.bbbtrade.net bbbtrade.net;

#     location ~* \.(?:js|css|png|jpg|jpeg|gif|svg|ico|woff2?|ttf|otf)$ {
#         proxy_pass http://cpx_website;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#         proxy_http_version 1.1;
#         add_header Cache-Control "public, max-age=2592000";
#         expires 30d;
#     }

#     location / {
#         proxy_pass http://cpx_website;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#         proxy_http_version 1.1;
#     }
# }
